#!/bin/bash

set -o errexit
set -o nounset
set -o pipefail

# Author: Philipp Moers <soziflip@gmail.com>
#
# backup
# A script to create backups using rsync.
#
# For certain directories this script creates incremental backups with hardlinks (think snapshots
# that refer to older snapshots). This is efficient both in terms of backup runtime performance and
# disk space usage.
# Note that backups won't be incremental on NTFS (doesn't support linux hardlinks)!
#
# Ideally, the script is run on a regular basis e.g. as a cron job.
# It can be run manually in addition to that.
#
# The script is for one way backups, e.g. to external hard drives.
# To sync directories across hosts, I use Syncthing.
#
# There are three kinds of groups of directories with different backup strategies:
# "data", "synced" and "unsynced".
#
# 1) "synced" directories are meant for personal data like documents etc. that I want on every host.
#    They are expected to be synced across hosts via a sync tool, not this backup script.
#    Backups will be incremental, i.e. the target will contain subdirectories per timestamp.
#    Since there is an external sync, there will be *no* subdirectories per host.
#    It is recommended to perform a sync before running this backup script, so that the directories
#    contain the most recent data. Otherwise only the present data will be in the snapshot and other
#    newer/older snapshots may contain other data. This may be confusing (but not cause data loss).
#    Deletions will be synced to the target (for the created snapshot).
# 2) "unsynced" directories are meant for other per-host data that I want to backup.
#    There will be one subdirectory per host.
#    Backups will be incremental, i.e. the target will contain subdirectories per timestamp.
#    Deletions will be synced to the target (for the created snapshot).
# 3) "data" directories are meant for bigger data collections like personal photos, that I *don't*
#    want on every host (for disk space reasons).
#    Backups will *not* be incremental, i.e. the target will *not* contain subdirectories
#    per timestamp.
#    Also, there will be no subdirectories per host, as this should generate a central backup of
#    data from different hosts - so hosts should use a common structure for this to work.
#    Deletions will not be synced to the target. However data could be overwritten!
#
#
# In the default synced directory the file 'README.md' explains order and file structure.
# The file 'tidy.txt' on external hard drives is outdated.


#############################
# CONFIGURATION STARTS HERE #
#############################

# Directory in which to create the backups:
# -----------------------------------------

# $BACKUP_DIR can be set via command line argument (--backup-dir)
DEFAULT_BACKUP_DIR="/mnt/wd-4tb/backup" # default value

# File structure that will be created in $BACKUP_DIR:
# /data/foo
# /data/bar
# /synced/latest
# /synced/$DATE/foo
# /synced/$DATE/bar
# /unsynced/$HOSTNAME/latest
# /unsynced/$HOSTNAME/$DATE/baz
# /unsynced/$HOSTNAME/$DATE/quz


# Directories that should be backed up:
# -------------------------------------

# Backups will be created in the `synced` directory.
# If they don't exist, they will just be skipped.
# Note the "/./" to limit relative paths, see https://unix.stackexchange.com/a/321224/119362
SYNCED_SOURCES=(
    "$HOME/./Sync"
    "$HOME/./work/code-intelligence"
    "$HOME/./work/reply"
)

# Backups will be created in the `unsynced` directory under the hostname.
# If they don't exist, they will just be skipped.
# Note the "/./" to limit relative paths, see https://unix.stackexchange.com/a/321224/119362
UNSYNCED_SOURCES=(
    "$HOME/./.azure"
    "$HOME/./.babashka"
    "$HOME/./.config"
    "$HOME/./.cargo"
    "$HOME/./.clojure"
    "$HOME/./.gnupg"
    "$HOME/./.netrc"
    "$HOME/./.local/share/mail"
    "$HOME/./.password-store"
    "$HOME/./.ssh"
    "$HOME/./bin"
    "$HOME/./opt"
    "$HOME/./os"
    "$HOME/./projects" # subdirs should be in a remove git repository, but hey
    "$HOME/./public-html"
    "$HOME/./work-projects/code-intelligence"
    "$HOME/./work-projects/reply"
)

# Backups will be added to the `data` backup directory.
# If they don't exist, they will just be skipped.
# Note the "/./" to limit relative paths, see https://unix.stackexchange.com/a/321224/119362
DATA_SOURCES=(
    "$HOME/./img-photo"
    "$HOME/./music-misc"
    "$HOME/./music-soundtracks"
    "$HOME/./music-vid"
    "$HOME/./recording"
    "$HOME/./snd-audiobooks"
    "$HOME/./vid"
    "$HOME/./vid-misc"
    "$HOME/./vid-movie"
)

###########################
# CONFIGURATION ENDS HERE #
###########################

DATE_HUMAN_READABLE="$(date)"
DATE="$(date +%Y-%m-%d-%H-%M-%S)"
TIME=$(date +%s)

LOG_DIR="$HOME/.backup.log"
LOG_FILE="$LOG_DIR/backup.$DATE.log"

HOSTNAME=$(hostname)

# RSYNC_OPTS must never contain "--delete", only RSYNC_OPTS_INCREMENTAL should!
RSYNC_OPTS=(
    "--verbose"
    "--archive"
    "--relative"
    "--exclude='.cache'"
)
RSYNC_OPTS_INCREMENTAL=("${RSYNC_OPTS[@]}")
RSYNC_OPTS_INCREMENTAL+=(
    "--delete"
)


function _print_help_msg()
{
    cat <<-EOF
Create backup of some configured files in $HOME.

Usage: $(basename "$0") [--backup-dir /path/to/backup/dir]

If no backup directory is given, $DEFAULT_BACKUP_DIR is used as a default.
EOF
}


function _backup_data()
{
    things=("$@")
    # Make sure to set $BACKUP_DATA_DIR env, too! (can't accept additional args)

    DESTINATION="$BACKUP_DATA_DIR"

    mkdir -p "$DESTINATION"

    for thing in "${things[@]}"; do
        echo -e "\nBacking up $thing ..."
        if ! test -e "$thing"; then
            echo "WARNING: $thing not found! Skipping."
        else
            echo "rsync ${RSYNC_OPTS[*]} $thing $DESTINATION"
            env rsync "${RSYNC_OPTS[@]}" "$thing" "$DESTINATION"
        fi
    done
}


function _create_backup_increment()
{
    things=("$@")
    # Make sure to set $BACKUP_LIST env, too! (can't accept additional args)

    DESTINATION="$BACKUP_LIST/$DATE"
    LATEST="$BACKUP_LIST/latest"

    LOCAL_RSYNC_OPTS=("${RSYNC_OPTS_INCREMENTAL[@]}")
    if [ -d "$LATEST" ]; then
        # --link-dest arguments have to be relative to the destination dir
        LATEST_RELATIVE="../$(readlink "$LATEST")"
        LOCAL_RSYNC_OPTS+=("--link-dest=$LATEST_RELATIVE")
    fi

    mkdir -p "$DESTINATION"

    for thing in "${things[@]}"; do
        echo -e "\nBacking up $thing ..."
        if ! test -e "$thing"; then
            echo "WARNING: $thing not found! Skipping."
        else
            echo "rsync ${LOCAL_RSYNC_OPTS[*]} $thing $DESTINATION"
            env rsync "${LOCAL_RSYNC_OPTS[@]}" "$thing" "$DESTINATION"
        fi
    done

    rm -f "$LATEST"
    ln -s --relative "$DESTINATION" "$LATEST"
}


function _main()
{
    echo "Started backup at $DATE_HUMAN_READABLE"
    # if ! mountpoint -q "$BACKUP_DIR"; then    # test if mounted ($BACKUP_DIR as mountpoint)
    if ! test -d "$BACKUP_DIR"; then    # ($BACKUP_DIR as subdir of mountpoint)
        echo "FATAL ERROR: Backup directory $BACKUP_DIR not found!"
        exit 1
    fi

    # SYNCED_SOURCES
    BACKUP_LIST="$BACKUP_DIR/synced"
    mkdir -p "$BACKUP_LIST"
    _create_backup_increment "${SYNCED_SOURCES[@]}"

    # UNSYNCED_SOURCES
    BACKUP_LIST="$BACKUP_DIR/unsynced/$HOSTNAME"
    mkdir -p "$BACKUP_LIST"
    _create_backup_increment "${UNSYNCED_SOURCES[@]}"

    # DATA_SOURCES
    BACKUP_DATA_DIR="$BACKUP_DIR/data"
    mkdir -p "$BACKUP_DATA_DIR"
    _backup_data "${DATA_SOURCES[@]}"

    DATE_FINISHED="$(date)"
    TIME_FINISHED=$(date +%s)
    EXECUTION_TIME=$((TIME_FINISHED - TIME))

    echo # newline
    echo "Finished backup at $DATE_FINISHED within $EXECUTION_TIME seconds."
    echo "This log has been written to $LOG_FILE"
}


if [[ "${1-default}" = "--help" ]]; then
    _print_help_msg
    exit
elif [[ "${1-default}" = "--backup-dir" ]]; then
    BACKUP_DIR="${2-$DEFAULT_BACKUP_DIR}"
else
    BACKUP_DIR="$DEFAULT_BACKUP_DIR"
fi

mkdir -p "$LOG_DIR"
touch "$LOG_FILE"
exec > >(tee "$LOG_FILE") 2>&1 # log to both, stdout/stderr and log file
_main
